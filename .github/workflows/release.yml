name: Release Automatique

on:
  pull_request:
    types: [ closed ]
    branches: [ main ]
  push:
    tags:
      - 'v*.*.*'  # DÃ©clenchÃ© par des tags comme v1.0.0, v0.8.1, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (ex: 1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release:
    name: CrÃ©er la Release GitHub
    runs-on: ubuntu-latest
    # Ne s'exÃ©cute que si la PR a Ã©tÃ© mergÃ©e OU si c'est un tag/manual
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch'
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: DÃ©terminer la nouvelle version
        id: get_version
        run: |
          # Si c'est un tag manuel
          if [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Version from tag: $VERSION"
            exit 0
          fi

          # Si c'est un workflow_dispatch manuel
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Version from input: $VERSION"
            exit 0
          fi

          # Sinon, calcul automatique depuis les commits (PR mergÃ©e)
          # RÃ©cupÃ©rer la derniÃ¨re version tag (ou 0.0.0 si aucune)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "DerniÃ¨re version: $LAST_TAG"

          # Extraire MAJOR, MINOR, PATCH
          VERSION=${LAST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # RÃ©cupÃ©rer les commits depuis le dernier tag
          if [ "$LAST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s" origin/main)
          else
            COMMITS=$(git log ${LAST_TAG}..origin/main --pretty=format:"%s")
          fi

          echo "Commits analysÃ©s:"
          echo "$COMMITS"

          # DÃ©terminer le type de version selon conventional commits
          if echo "$COMMITS" | grep -qiE "^(feat!|fix!|chore!):|BREAKING CHANGE:"; then
            # MAJOR version (breaking change)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            VERSION_TYPE="major"
          elif echo "$COMMITS" | grep -qiE "^feat(\(.+\))?:"; then
            # MINOR version (nouvelle fonctionnalitÃ©)
            MINOR=$((MINOR + 1))
            PATCH=0
            VERSION_TYPE="minor"
          elif echo "$COMMITS" | grep -qiE "^(fix|test|docs|refactor|chore)(\(.+\))?:"; then
            # PATCH version (correction, tests, docs, etc.)
            PATCH=$((PATCH + 1))
            VERSION_TYPE="patch"
          else
            # Par dÃ©faut, PATCH version
            PATCH=$((PATCH + 1))
            VERSION_TYPE="patch"
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "Nouvelle version: $NEW_VERSION (type: $VERSION_TYPE)"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "last_version=$LAST_TAG" >> $GITHUB_OUTPUT

      - name: GÃ©nÃ©rer les notes de version
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # Utiliser la variable last_version dÃ©jÃ  calculÃ©e pour Ã©viter les problÃ¨mes de timing
          PREV_TAG="${{ steps.get_version.outputs.last_version }}"

          echo "## ðŸŽ‰ Padel Overlay Generator v$VERSION" > release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“¥ TÃ©lÃ©chargements" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **Windows**: \`PadelOverlayGenerator-Windows.exe\`" >> release_notes.md
          echo "- **macOS**: \`PadelOverlayGenerator-macOS\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“ Changements" >> release_notes.md
          echo "" >> release_notes.md

          if [ -n "$PREV_TAG" ]; then
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" >> release_notes.md
          else
            git log --pretty=format:"- %s (%h)" --max-count=20 >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "### âš™ï¸ Configuration requise" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **FFmpeg** doit Ãªtre installÃ© sur votre systÃ¨me" >> release_notes.md
          echo "- **Windows**: Windows 10/11 (64-bit)" >> release_notes.md
          echo "- **macOS**: macOS 11+ (Big Sur ou plus rÃ©cent)" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“– Utilisation" >> release_notes.md
          echo "" >> release_notes.md
          echo "1. TÃ©lÃ©chargez l'exÃ©cutable correspondant Ã  votre systÃ¨me" >> release_notes.md
          echo "2. Installez FFmpeg si ce n'est pas dÃ©jÃ  fait" >> release_notes.md
          echo "3. Lancez l'application" >> release_notes.md
          echo "4. SÃ©lectionnez vos fichiers (XML, Excel, vidÃ©os)" >> release_notes.md
          echo "5. Cliquez sur \"GÃ©nÃ©rer la vidÃ©o avec overlays\"" >> release_notes.md

          cat release_notes.md

      - name: CrÃ©er la Release GitHub
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Version ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-upload:
    name: Build et Upload ${{ matrix.os }}
    needs: create-release
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_name: PadelOverlayGenerator-Windows.exe
            build_name: PadelOverlayGenerator.exe
            asset_content_type: application/vnd.microsoft.portable-executable
          - os: macos-latest
            artifact_name: PadelOverlayGenerator-macOS
            build_name: PadelOverlayGenerator
            asset_content_type: application/octet-stream

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Installation de FFmpeg (Windows)
        if: runner.os == 'Windows'
        run: choco install ffmpeg -y

      - name: Installation de FFmpeg (macOS)
        if: runner.os == 'macOS'
        run: brew install ffmpeg

      - name: Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pyinstaller

      - name: Build avec PyInstaller
        run: python utils/build_exe.py

      - name: Renommer et prÃ©parer l'exÃ©cutable
        shell: bash
        run: |
          cd dist
          mv "${{ matrix.build_name }}" "${{ matrix.artifact_name }}"
          ls -lh

          # Calculer le checksum
          if [ "$RUNNER_OS" == "Windows" ]; then
            certutil -hashfile "${{ matrix.artifact_name }}" SHA256 > "${{ matrix.artifact_name }}.sha256"
          else
            shasum -a 256 "${{ matrix.artifact_name }}" > "${{ matrix.artifact_name }}.sha256"
          fi

      - name: Upload de l'exÃ©cutable vers la Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            dist/${{ matrix.artifact_name }}
            dist/${{ matrix.artifact_name }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: RÃ©sumÃ©
        run: |
          echo "### âœ… Build et Upload rÃ©ussis - ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.create-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** ${{ matrix.artifact_name }}" >> $GITHUB_STEP_SUMMARY
        shell: bash